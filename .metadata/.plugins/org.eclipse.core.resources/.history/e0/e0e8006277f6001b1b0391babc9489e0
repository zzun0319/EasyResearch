<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.junhee.EasyResearch.Research.Repository.IResearchMapper">

	<resultMap id="UserMap" type="com.junhee.EasyResearch.Model.UserVO">
		<id property="userId" column="user_id" />
		<result property="userPw" column="user_pw" />
		<result property="univIdNum" column="univ_id_num"/>
		<result property="email" column="email"/>
		<result property="tel" column="tel"/>
		<result property="major" column="major"/>
		<result property="userType" column="user_type"/>
		<result property="participationRight" column="participation_right"/>
		<result property="setupRight" column="setup_right"/>
		<result property="classRegiRight" column="class_regi_right"/>
		<result property="permissionRight" column="permission_right"/>
		<result property="userName" column="user_name"/>
	</resultMap>

	<resultMap id="ResearchMap" type="com.junhee.EasyResearch.Model.ResearchVO" >
		<id property="researchId" column="research_id" />
		<result property="researchType" column="research_type" />
		<result property="title" column="title" />
		<result property="purpose" column="purpose" />
		<result property="method" column="method" />
		<result property="rewardType" column="reward_type" />
		<result property="rewardValue" column="reward_value" />
		<result property="duration" column="duration" />
		<result property="permission" column="permission" />
		<result property="uploadFileName" column="upload_file_name" />
		<result property="savedFileName" column="saved_file_name" />
		<association property="researcher" column="researcher" javaType="com.junhee.EasyResearch.Model.UserVO" resultMap="UserMap" />
	</resultMap>
	
	<resultMap id="CommentMap" type="com.junhee.EasyResearch.Model.CommentVO">
		<id property="commentId" column="comment_id" />
		<result property="researchId" column="research_id"/>
		<result property="content" column="content"/>
		<result property="writeDate" column="write_date"/>
		<association property="writer" column="writer" javaType="com.junhee.EasyResearch.Model.UserVO" resultMap="UserMap" />
	</resultMap>
	
	<insert id="RegisterResearch">
		INSERT INTO research (research_type, title, purpose, method, reward_type, reward_value, duration, upload_file_name, saved_file_name, researcher) 
		VALUES (#{researchType},#{title},#{purpose},#{method},#{rewardType},#{rewardValue},#{duration},#{uploadFileName}, #{savedFileName}, #{researcher.userId})
	</insert>
	
	<insert id="RegisterComment">
		INSERT INTO comments (research_id, content, writer) VALUES (#{researchId},#{content},#{writer.userId})
	</insert>
	
	<select id="GetMyResearch" resultMap="ResearchMap">
		SELECT * FROM research WHERE researcher=#{userId}
	</select>
	
	<select id="GetResearchInfo" resultMap="ResearchMap">
		SELECT r.*, u.user_id FROM research r JOIN er_users u WHERE r.research_id=#{researchId} AND u.user_id = r.researcher
	</select>
	
	<select id="GetSameMajorResearch" resultMap="ResearchMap">
		SELECT r.*, u.user_id, u.user_name FROM research r
		JOIN er_users u ON r.researcher = u.user_id
		WHERE u.major = #{major} AND u.user_type IN ('석사과정대학원생', '박사과정대학원생')
		ORDER BY research_id DESC
		LIMIT 10 OFFSET ((#{pageNum}-1) * 10)
	</select>
	
	<select id="GetResearchComments" resultMap="CommentMap">
		SELECT C.*, u.user_id, u.user_name FROM comments c JOIN er_users u 
		ON c.writer = u.user_id WHERE c.research_id=#{researchId} ORDER BY write_date DESC
	</select>
	
	<update id="PermitResearch">
		UPDATE research SET permission=#{permission} WHERE research_id=#{researchId}
	</update>

</mapper>